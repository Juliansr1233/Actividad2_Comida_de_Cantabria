{% capture tocWorkspace %}
    {% comment %}
        Copyright (c) 2017 Carlos Aguilar Hernández

        Por la presente se concede permiso, de forma gratuita, a cualquier persona
        obtener una copia de este software y la documentación asociada
        archivos (el "Software"), para operar con el Software sin
        restricción, incluidos, entre otros, los derechos de uso,
        copiar, modificar, fusionar, publicar, distribuir, sublicenciar y/o vender
        copias del Software y para permitir a las personas a quienes
        Se proporciona software para hacerlo, sujeto a lo siguiente
        condiciones:

        El aviso de derechos de autor anterior y este aviso de permiso serán
        incluido en todas las copias o partes sustanciales del Software.

        EL SOFTWARE SE PROPORCIONA "TAL CUAL", SIN GARANTÍA DE NINGÚN TIPO,
        EXPRESA O IMPLÍCITA, INCLUYENDO PERO NO LIMITADO A LAS GARANTÍAS
        DE COMERCIABILIDAD, IDONEIDAD PARA UN FIN DETERMINADO Y
        NO INFRACCIÓN. EN NINGÚN CASO LOS AUTORES O LOS DERECHOS DE AUTOR
        LOS TITULARES SERÁN RESPONSABLES DE CUALQUIER RECLAMACIÓN, DAÑO U OTRA RESPONSABILIDAD,
        YA SEA EN UNA ACCIÓN DE CONTRATO, AGRAVIO O DE OTRA MANERA, QUE SURJA
        DE, FUERA DE O EN RELACIÓN CON EL SOFTWARE O EL USO O
        OTROS NEGOCIOS EN EL SOFTWARE.
    {% endcomment %}
    {% comment %}
        Version 1.0.14
          https://github.com/allejo/jekyll-toc

        "...like all things liquid - where there's a will, and ~36 hours to spare, there's usually a/some way" ~jaybe

        Usage:
            {% include toc.html html=content sanitize=true class="inline_toc" id="my_toc" h_min=2 h_max=3 %}

        Parameters:
            * html         (string) - the HTML of compiled markdown generated by kramdown in Jekyll

        Optional Parameters:
            * sanitize      (bool)   : false  - when set to true, the headers will be stripped of any HTML in the TOC
            * class         (string) :   ''   - a CSS class assigned to the TOC
            * id            (string) :   ''   - an ID to assigned to the TOC
            * h_min         (int)    :   1    - the minimum TOC header level to use; any header lower than this value will be ignored
            * h_max         (int)    :   6    - the maximum TOC header level to use; any header greater than this value will be ignored
            * ordered       (bool)   : false  - when set to true, an ordered list will be outputted instead of an unordered list
            * item_class    (string) :   ''   - add custom class(es) for each list item; has support for '%level%' placeholder, which is the current heading level
            * submenu_class (string) :   ''   - add custom class(es) for each child group of headings; has support for '%level%' placeholder which is the current "submenu" heading level
            * baseurl       (string) :   ''   - add a base url to the TOC links for when your TOC is on another page than the actual content
            * anchor_class  (string) :   ''   - add custom class(es) for each anchor element
            * skipNoIDs     (bool)   : false  - skip headers that do not have an `id` attribute

        Output:
            An ordered or unordered list representing the table of contents of a markdown block. This snippet will only
            generate the table of contents and will NOT output the markdown given to it
    {% endcomment %}

    {% capture my_toc %}{% endcapture %}
    {% assign orderedList = include.ordered | default: false %}
    {% assign skipNoIDs = include.skipNoIDs | default: false %}
    {% assign minHeader = include.h_min | default: 1 %}
    {% assign maxHeader = include.h_max | default: 6 %}
    {% assign nodes = include.html | split: '<h' %}
    {% assign firstHeader = true %}
    {% assign previousLevel = 0 %}

    {% capture listModifier %}{% if orderedList %}1.{% else %}-{% endif %}{% endcapture %}

    {% for node in nodes %}
        {% if node == "" %}
            {% continue %}
        {% endif %}

        {% assign headerLevel = node | replace: '"', '' | slice: 0, 1 | times: 1 %}

        {% if headerLevel < minHeader or headerLevel > maxHeader %}
            {% continue %}
        {% endif %}

        {% assign _workspace = node | split: '</h' %}

        {% assign _idWorkspace = _workspace[0] | split: 'id="' %}
        {% assign _idWorkspace = _idWorkspace[1] | split: '"' %}
        {% assign html_id = _idWorkspace[0] %}

        {% assign _classWorkspace = _workspace[0] | split: 'class="' %}
        {% assign _classWorkspace = _classWorkspace[1] | split: '"' %}
        {% assign html_class = _classWorkspace[0] %}

        {% if html_class contains "no_toc" %}
            {% continue %}
        {% endif %}

        {% if firstHeader %}
            {% assign firstHeader = false %}
            {% assign minHeader = headerLevel %}
        {% endif %}

        {% capture _hAttrToStrip %}{{ _workspace[0] | split: '>' | first }}>{% endcapture %}
        {% assign header = _workspace[0] | replace: _hAttrToStrip, '' %}

        {% assign indentAmount = headerLevel | minus: minHeader %}
        {% assign space = '' %}
        {% for i in (1..indentAmount) %}
            {% assign space = space | prepend: '    ' %}
        {% endfor %}

        {% if include.item_class and include.item_class != blank %}
            {% capture listItemClass %}{:.{{ include.item_class | replace: '%level%', headerLevel }}}{% endcapture %}
        {% endif %}

        {% capture anchor_body %}{% if include.sanitize %}{{ header | strip_html }}{% else %}{{ header }}{% endif %}{% endcapture %}
        {% capture anchor_body %}{{ anchor_body | replace: "|", "\|" }}{% endcapture %}

        {% if html_id %}
            {% capture list_item %}[{{ anchor_body }}]({% if include.baseurl %}{{ include.baseurl }}{% endif %}#{{ html_id }}){% endcapture %}
        {% elsif skipNoIDs == true %}
            {% continue %}
        {% else %}
            {% capture list_item %}{{ anchor_body }}{% endcapture %}
        {% endif %}

        <!--
        If we have a submenu class and we're unindenting, then we need to add a "closing" class to this group of bullet
        points
        -->
        {% if include.submenu_class and previousLevel > indentAmount %}
            <!--
            `space` is the current indentation, so we if want to close off the previous grouping, we need to add one
            more level of indentation 
            -->
            {% assign submenuIndentation = space | prepend: '    ' %}

            {% capture my_toc %}{{ my_toc }}
{{ submenuIndentation }}{:.{{ include.submenu_class | replace: '%level%', previousLevel }}}{% endcapture %}
        {% endif %}

        {% capture my_toc %}{{ my_toc }}
{{ space }}{{ listModifier }} {{ listItemClass }} {{ list_item }}{% if include.anchor_class %}{:.{{ include.anchor_class }}}{% endif %}{% endcapture %}

        {% assign previousLevel = indentAmount %}
    {% endfor %}

    {% if include.class and include.class != blank %}
        {% capture my_toc %}{:.{{ include.class }}}
{{ my_toc | lstrip }}{% endcapture %}
    {% endif %}

    {% if include.id %}
        {% capture my_toc %}{: #{{ include.id }}}
{{ my_toc | lstrip }}{% endcapture %}
    {% endif %}

    <!--
    If we have a submenu class, we need to close off all the remaining list item groups so that submenu classes are
    applied correctly to them
    -->
    {% if include.submenu_class != blank %}
        <!-- The last level of indentation that we were at, we need to work backwards from there closing each group -->
        {% for i in (1..previousLevel) %}
            {% assign lvl = previousLevel | plus: 1 | minus: i %} <!-- Invert the indent level based on `i` -->
            {% assign closingSpace = '' %}

            {% for i in (1..lvl) %}
                {% assign closingSpace = closingSpace | prepend: '    ' %}
            {% endfor %}

            {% capture my_toc %}{{ my_toc }}
{{ closingSpace }}{:.{{ include.submenu_class | replace: '%level%', lvl }}}{% endcapture %}
        {% endfor %}
    {% endif %}
{% endcapture %}{% assign tocWorkspace = '' %}{{ my_toc | markdownify | strip }}
